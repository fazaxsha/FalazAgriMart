-- QUERY TRUNCATED
-- ============================================
-- FALAZ AgriMart - Complete Database Script
-- PostgreSQL (Neon Database)
-- ============================================

-- 1. DROP EXISTING TABLES (Hati-hati! Ini akan hapus semua data)
-- Uncomment jika ingin reset database
/*
DROP TABLE IF EXISTS detail_transaksi CASCADE;
DROP TABLE IF EXISTS transaksi CASCADE;
DROP TABLE IF EXISTS produk CASCADE;
DROP TABLE IF EXISTS kategori CASCADE;
DROP TABLE IF EXISTS supplier CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP TYPE IF EXISTS user_role_enum;
*/

-- ============================================
-- 2. CREATE TYPE ENUM untuk Role User
-- ============================================
CREATE TYPE user_role_enum AS ENUM ('Admin', 'Pegawai');

-- ============================================
-- 3. CREATE TABLES
-- ============================================

-- Tabel Users (Gabungan Admin & Pegawai)
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    nama_lengkap VARCHAR(100) NOT NULL,
    role user_role_enum NOT NULL,
    status BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabel Kategori
CREATE TABLE kategori (
    kategori_id SERIAL PRIMARY KEY,
    nama_kategori VARCHAR(50) NOT NULL UNIQUE,
    deskripsi TEXT,
    status BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabel Supplier
CREATE TABLE supplier (
    supplier_id SERIAL PRIMARY KEY,
    nama_supplier VARCHAR(100) NOT NULL,
    alamat TEXT,
    no_telp VARCHAR(20),
    email VARCHAR(100),
    status BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabel Produk
CREATE TABLE produk (
    produk_id SERIAL PRIMARY KEY,
    nama_produk VARCHAR(100) NOT NULL,
    kategori_id INT,
    satuan VARCHAR(20) NOT NULL,
    harga NUMERIC(10, 2) NOT NULL CHECK (harga >= 0),
    stok INT DEFAULT 0 CHECK (stok >= 0),
    stok_minimum INT DEFAULT 10,
    supplier_id INT,
    status BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_kategori 
        FOREIGN KEY (kategori_id) 
        REFERENCES kategori(kategori_id) 
        ON DELETE SET NULL 
        ON UPDATE CASCADE,
    CONSTRAINT fk_supplier 
        FOREIGN KEY (supplier_id) 
        REFERENCES supplier(supplier_id) 
        ON DELETE SET NULL 
        ON UPDATE CASCADE
);

-- Tabel Transaksi (Header)
CREATE TABLE transaksi (
    transaksi_id SERIAL PRIMARY KEY,
    no_transaksi VARCHAR(50) NOT NULL UNIQUE,
    tanggal_transaksi TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    nama_pelanggan VARCHAR(100),
    total_bayar NUMERIC(12, 2) NOT NULL CHECK (total_bayar >= 0),
    jumlah_bayar NUMERIC(12, 2) NOT NULL CHECK (jumlah_bayar >= 0),
    kembalian NUMERIC(12, 2) NOT NULL CHECK (kembalian >= 0),
    user_id INT NOT NULL,
    catatan TEXT,
    CONSTRAINT fk_user 
        FOREIGN KEY (user_id) 
        REFERENCES users(user_id)
        ON DELETE RESTRICT
        ON UPDATE CASCADE
);

-- Tabel Detail Transaksi
CREATE TABLE detail_transaksi (
    detail_id SERIAL PRIMARY KEY,
    transaksi_id INT NOT NULL,
    produk_id INT NOT NULL,
    nama_produk VARCHAR(100) NOT NULL,      -- Snapshot
    harga_satuan NUMERIC(10, 2) NOT NULL,   -- Snapshot
    quantity INT NOT NULL CHECK (quantity > 0),
    subtotal NUMERIC(12, 2) NOT NULL CHECK (subtotal >= 0),
    CONSTRAINT fk_transaksi 
        FOREIGN KEY (transaksi_id) 
        REFERENCES transaksi(transaksi_id) 
        ON DELETE CASCADE,
    CONSTRAINT fk_produk 
        FOREIGN KEY (produk_id) 
        REFERENCES produk(produk_id)
        ON DELETE RESTRICT
);

-- ============================================
-- 4. CREATE INDEXES untuk Performance
-- ============================================

CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_produk_nama ON produk(nama_produk);
CREATE INDEX idx_produk_stok ON produk(stok);
CREATE INDEX idx_transaksi_tanggal ON transaksi(tanggal_transaksi);
CREATE INDEX idx_transaksi_user ON transaksi(user_id);
CREATE INDEX idx_detail_transaksi ON detail_transaksi(transaksi_id);

-- ============================================
-- 5. CREATE FUNCTIONS & TRIGGERS
-- ============================================

-- Function untuk update timestamp
CREATE OR REPLACE FUNCTION update_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger untuk auto update timestamp
CREATE TRIGGER trigger_update_users
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_timestamp();

CREATE TRIGGER trigger_update_supplier
    BEFORE UPDATE ON supplier
    FOR EACH ROW
    EXECUTE FUNCTION update_timestamp();

CREATE TRIGGER trigger_update_produk
    BEFORE UPDATE ON produk
    FOR EACH ROW
    EXECUTE FUNCTION update_timestamp();

-- ============================================
-- 6. INSERT DATA DUMMY
-- ============================================

-- DATA USERS
INSERT INTO users (username, password, nama_lengkap, role, status) VALUES 
('admin', 'admin123', 'Zaki Raya Andhika', 'Admin', TRUE),
('admin2', 'admin123', 'Administrator Backup', 'Admin', TRUE),
('kasir1', 'kasir123', 'Lutfi Rosyadi', 'Pegawai', TRUE),
('kasir2', 'kasir123', 'Fajar Ilham Arifiyanto', 'Pegawai', TRUE),
('kasir3', 'kasir123', 'Budi Santoso', 'Pegawai', TRUE),
('kasir4', 'kasir123', 'Siti Nurhaliza', 'Pegawai', FALSE); -- Nonaktif

-- DATA KATEGORI
INSERT INTO kategori (nama_kategori, deskripsi, status) VALUES 
('Buah Lokal', 'Buah-buahan hasil produksi dalam negeri', TRUE),
('Buah Impor', 'Buah-buahan import dari luar negeri', TRUE),
('Sayuran', 'Sayuran segar', TRUE),
('Buah Tropis', 'Buah-buahan khas daerah tropis', TRUE),
('Buah Premium', 'Buah-buahan kualitas premium', TRUE);

-- DATA SUPPLIER
INSERT INTO supplier (nama_supplier, alamat, no_telp, email, status) VALUES 
('UD Segar Jaya', 'Jl. Kalimantan No. 10 Jember', '08123456789', 'segarjaya@email.com', TRUE),
('CV Buah Nusantara', 'Jl. Sumatera No. 25 Jember', '08234567890', 'buahnusantara@email.com', TRUE),
('PT Fresh Fruit Indonesia', 'Jl. Bali No. 15 Surabaya', '08345678901', 'freshfruit@email.com', TRUE),
('Toko Sumber Makmur', 'Jl. Kaliurang KM 5 Yogyakarta', '08456789012', 'sumbermakmur@email.com', TRUE),
('CV Agro Mandiri', 'Jl. Veteran No. 30 Malang', '08567890123', 'agromandir@email.com', TRUE);

-- DATA PRODUK (30+ items)
INSERT INTO produk (nama_produk, kategori_id, satuan, harga, stok, stok_minimum, supplier_id, status) VALUES 
-- Buah Lokal
('Jeruk Pontianak', 1, 'Kg', 18000, 100, 10, 1, TRUE),
('Pisang Ambon', 1, 'Kg', 15000, 80, 10, 1, TRUE),
('Mangga Harum Manis', 1, 'Kg', 25000, 60, 10, 2, TRUE),
('Pepaya California', 1, 'Kg', 12000, 50, 10, 2, TRUE),
('Semangka', 1, 'Kg', 8000, 120, 15, 1, TRUE),
('Melon', 1, 'Kg', 20000, 45, 10, 2, TRUE),
('Nanas Madu', 1, 'Kg', 15000, 70, 10, 1, TRUE),
('Jambu Air', 1, 'Kg', 18000, 55, 10, 2, TRUE),
('Salak Pondoh', 1, 'Kg', 22000, 40, 10, 1, TRUE),
('Durian Montong', 1, 'Kg', 85000, 8, 5, 3, TRUE), -- Stok rendah!

-- Buah Impor
('Apel Fuji', 2, 'Kg', 35000, 50, 10, 3, TRUE),
('Apel Washington', 2, 'Kg', 42000, 35, 10, 3, TRUE),
('Pir China', 2, 'Kg', 38000, 40, 10, 3, TRUE),
('Anggur Hijau', 2, 'Kg', 55000, 30, 8, 3, TRUE),
('Anggur Merah', 2, 'Kg', 58000, 28, 8, 3, TRUE),
('Kiwi', 2, 'Kg', 65000, 25, 5, 4, TRUE),
('Jeruk Mandarin', 2, 'Kg', 48000, 45, 10, 3, TRUE),
('Strawberry', 2, 'Kg', 75000, 7, 5, 4, TRUE), -- Stok rendah!

-- Buah Tropis
('Mangga Alpukat', 4, 'Kg', 30000, 50, 10, 2, TRUE),
('Kelapa Muda', 4, 'Buah', 10000, 60, 15, 1, TRUE),
('Rambutan', 4, 'Kg', 20000, 55, 10, 1, TRUE),
('Manggis', 4, 'Kg', 40000, 35, 8, 2, TRUE),
('Duku', 4, 'Kg', 35000, 30, 8, 2, TRUE),

-- Buah Premium
('Apel Envy', 5, 'Kg', 95000, 20, 5, 4, TRUE),
('Cherry', 5, 'Kg', 120000, 6, 5, 4, TRUE), -- Stok rendah!
('Blueberry', 5, 'Kg', 150000, 4, 3, 4, TRUE), -- Stok rendah!
('Alpukat Mentega', 5, 'Kg', 45000, 35, 8, 3, TRUE),
('Kurma Ajwa', 5, 'Kg', 180000, 25, 5, 4, TRUE),
('Melon Yubari', 5, 'Kg', 250000, 3, 2, 4, TRUE), -- Stok rendah!
('Dragon Fruit', 5, 'Kg', 35000, 40, 8, 2, TRUE);

-- DATA TRANSAKSI (10 transaksi contoh)
-- Transaksi hari ini
INSERT INTO transaksi (no_transaksi, tanggal_transaksi, nama_pelanggan, total_bayar, jumlah_bayar, kembalian, user_id, catatan) VALUES 
('TRX-' || TO_CHAR(CURRENT_DATE, 'YYYYMMDD') || '-0001', CURRENT_TIMESTAMP, 'Budi Hartono', 150000, 150000, 0, 3, 'Pelanggan tetap'),
('TRX-' || TO_CHAR(CURRENT_DATE, 'YYYYMMDD') || '-0002', CURRENT_TIMESTAMP, 'Siti Aminah', 75000, 100000, 25000, 3, NULL),
('TRX-' || TO_CHAR(CURRENT_DATE, 'YYYYMMDD') || '-0003', CURRENT_TIMESTAMP, 'Ahmad Yani', 320000, 350000, 30000, 4, 'Beli untuk acara